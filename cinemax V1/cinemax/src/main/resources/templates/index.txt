<!doctype html>
<html lang="fr" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cin√©ma R√©servation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            box-sizing: border-box;
        }
        .loading {
            opacity: 0.6;
            pointer-events: none;
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="h-full bg-gray-50 font-sans">
    <!-- Conteneur pour les notifications -->
    <div id="toast-container"></div>

    <!-- Barre de navigation -->
    <header class="bg-blue-900 text-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 id="site-title" class="text-2xl font-bold cursor-pointer" onclick="showPage('home')">Cin√©Max</h1>
                <nav class="hidden md:flex space-x-6">
                    <a href="#" id="nav-home" class="nav-link px-3 py-2 rounded-md hover:bg-blue-800 transition-colors" onclick="showPage('home')">üè† Accueil</a>
                    <a href="#" id="nav-movies" class="nav-link px-3 py-2 rounded-md hover:bg-blue-800 transition-colors" onclick="showPage('movies')">üé¨ Films</a>
                    <a href="#" id="nav-reservations" class="nav-link px-3 py-2 rounded-md hover:bg-blue-800 transition-colors hidden" onclick="showPage('reservations')">üé´ R√©servations</a>
                    <a href="#" id="nav-admin" class="nav-link px-3 py-2 rounded-md hover:bg-blue-800 transition-colors hidden" onclick="showPage('admin')">‚öôÔ∏è Admin</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <div id="user-menu" class="hidden">
                        <span id="user-welcome" class="text-blue-200 mr-4"></span>
                        <button onclick="showPage('profile')" class="bg-blue-700 hover:bg-blue-600 px-3 py-2 rounded-md transition-colors">üë§ Profil</button>
                        <button onclick="logout()" class="bg-red-600 hover:bg-red-700 px-3 py-2 rounded-md transition-colors ml-2">üö™ D√©connexion</button>
                    </div>
                    <div id="guest-menu">
                        <button onclick="showPage('login')" class="bg-green-600 hover:bg-green-700 px-4 py-2 rounded-md transition-colors">üîë Connexion</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Contenu principal -->
    <main class="max-w-7xl mx-auto px-4 py-8">
        <!-- Page de Connexion -->
        <div id="login-page" class="page">
            <div class="max-w-md mx-auto bg-white rounded-lg shadow-md p-8">
                <h2 id="login-title" class="text-2xl font-bold text-center mb-6">Connexion</h2>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Type de compte</label>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="role-user" class="role-btn border-2 border-gray-300 rounded-lg p-3 text-center hover:border-blue-500 transition-colors" onclick="selectRole('user')">
                            <div class="text-2xl mb-1">üé¨</div>
                            <div class="text-sm font-medium">Client</div>
                        </button>
                        <button type="button" id="role-admin" class="role-btn border-2 border-gray-300 rounded-lg p-3 text-center hover:border-blue-500 transition-colors" onclick="selectRole('admin')">
                            <div class="text-2xl mb-1">üë®‚Äçüíº</div>
                            <div class="text-sm font-medium">Admin</div>
                        </button>
                    </div>
                </div>
                <form id="login-form">
                    <div class="space-y-4">
                        <div>
                            <label for="login-username" class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
                            <input type="text" id="login-username" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                            <input type="password" id="login-password" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </div>
                        <button type="submit" id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md transition-colors">Se connecter</button>
                    </div>
                </form>
                <div class="mt-6 text-center">
                    <p class="text-sm text-gray-600">Pas de compte ?</p>
                    <button onclick="showRegisterForm()" class="text-blue-600 hover:text-blue-800 font-medium">Cr√©er un compte</button>
                </div>
                <div id="register-form" class="hidden mt-6 pt-6 border-t border-gray-200">
                    <h3 class="text-lg font-semibold mb-4">Cr√©er un compte</h3>
                    <form id="registration-form">
                        <div class="space-y-3">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label for="reg-firstname" class="block text-sm font-medium text-gray-700">Pr√©nom</label>
                                    <input type="text" id="reg-firstname" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                                <div>
                                    <label for="reg-lastname" class="block text-sm font-medium text-gray-700">Nom</label>
                                    <input type="text" id="reg-lastname" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                                </div>
                            </div>
                            <div>
                                <label for="reg-username" class="block text-sm font-medium text-gray-700">Nom d'utilisateur</label>
                                <input type="text" id="reg-username" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="reg-email" class="block text-sm font-medium text-gray-700">Email</label>
                                <input type="email" id="reg-email" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="reg-phone" class="block text-sm font-medium text-gray-700">T√©l√©phone</label>
                                <input type="tel" id="reg-phone" class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <div>
                                <label for="reg-password" class="block text-sm font-medium text-gray-700">Mot de passe</label>
                                <input type="password" id="reg-password" required class="mt-1 block w-full border border-gray-300 rounded-md px-3 py-2">
                            </div>
                            <button type="submit" id="register-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md">Cr√©er le compte</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Page d'Accueil -->
        <div id="home-page" class="page">
            <div class="text-center mb-8">
                <h2 id="welcome-message" class="text-3xl font-bold text-gray-800 mb-4">Bienvenue dans notre cin√©ma !</h2>
                <p class="text-lg text-gray-600">D√©couvrez les derniers films √† l'affiche</p>
            </div>
            <section class="mb-12">
                <h3 class="text-2xl font-semibold mb-6 flex items-center">üé¨ Films R√©cents</h3>
                <div id="recent-movies" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
            </section>
            <section class="grid md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600" id="total-movies">0</div>
                    <div class="text-gray-600">Films √† l'affiche</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl font-bold text-green-600" id="total-seats">0</div>
                    <div class="text-gray-600">Places disponibles</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-6 text-center">
                    <div class="text-3xl font-bold text-purple-600" id="total-reservations">0</div>
                    <div class="text-gray-600">R√©servations actives</div>
                </div>
            </section>
        </div>

        <!-- Page Films -->
        <div id="movies-page" class="page">
            <h2 class="text-2xl font-bold mb-6">üé¨ Tous les Films</h2>
            <div id="all-movies-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- Page R√©servations -->
        <div id="reservations-page" class="page">
            <h2 class="text-2xl font-bold mb-6">üé´ Mes R√©servations</h2>
            <div id="user-reservations-list" class="space-y-4"></div>
        </div>

        <!-- Page Profil -->
        <div id="profile-page" class="page">
            <div class="max-w-2xl mx-auto">
                <h2 id="profile-title" class="text-2xl font-bold mb-6">üë§ Mon Profil</h2>
                <div class="bg-white rounded-lg shadow-md p-6">
                    <form id="profile-form">
                        <div class="grid md:grid-cols-2 gap-6">
                            <div><label for="profile-firstname" class="block text-sm font-medium">Pr√©nom</label><input type="text" id="profile-firstname" class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="profile-lastname" class="block text-sm font-medium">Nom</label><input type="text" id="profile-lastname" class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="profile-username" class="block text-sm font-medium">Nom d'utilisateur</label><input type="text" id="profile-username" class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="profile-email" class="block text-sm font-medium">Email</label><input type="email" id="profile-email" class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="profile-phone" class="block text-sm font-medium">T√©l√©phone</label><input type="tel" id="profile-phone" class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="profile-role" class="block text-sm font-medium">R√¥le</label><input type="text" id="profile-role" readonly class="mt-1 block w-full border rounded-md p-2 bg-gray-100"></div>
                        </div>
                        <div class="mt-6"><button type="submit" id="update-profile-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-6 rounded-md">Mettre √† jour</button></div>
                    </form>
                </div>
                <div class="mt-8 bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-lg font-semibold mb-4">üìä Mes Statistiques</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600" id="user-total-reservations">0</div>
                            <div class="text-sm text-gray-600">R√©servations totales</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-green-600" id="user-total-tickets">0</div>
                            <div class="text-sm text-gray-600">Billets achet√©s</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page D√©tail Film -->
        <div id="movie-detail-page" class="page">
            <div class="max-w-4xl mx-auto">
                <button onclick="showPage('movies')" class="mb-4 text-blue-600 hover:text-blue-800 flex items-center">‚Üê Retour aux films</button>
                <div id="movie-detail-content"></div>
            </div>
        </div>

        <!-- Page Admin -->
        <div id="admin-page" class="page">
            <h2 class="text-2xl font-bold mb-6">‚öôÔ∏è Administration</h2>
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h3 class="text-xl font-semibold mb-4">üé≠ Gestion des Films</h3>
                <div class="grid md:grid-cols-2 gap-6">
                    <div>
                        <h4 class="font-medium mb-3">Ajouter un Film</h4>
                        <form id="add-movie-form" class="space-y-3">
                            <div><label for="movie-title" class="block text-sm font-medium">Titre</label><input type="text" id="movie-title" required class="mt-1 block w-full border rounded-md p-2"></div>
                            <div>
                               <label for="movie-genre" class="block text-sm font-medium">Genre</label>
                               <select id="movie-genre" required class="mt-1 block w-full border rounded-md p-2">
                                    <option value="">S√©lectionner</option> <option value="Action">Action</option> <option value="Com√©die">Com√©die</option> <option value="Drame">Drame</option>
                                    <option value="Horreur">Horreur</option> <option value="Romance">Romance</option> <option value="Sci-Fi">Science-Fiction</option>
                                </select>
                            </div>
                            <div><label for="movie-duration" class="block text-sm font-medium">Dur√©e</label><input type="text" id="movie-duration" placeholder="ex: 2h 15min" required class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="movie-price" class="block text-sm font-medium">Prix (‚Ç¨)</label><input type="number" id="movie-price" step="0.01" min="0" required class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="movie-showtime" class="block text-sm font-medium">Horaire</label><input type="datetime-local" id="movie-showtime" required class="mt-1 block w-full border rounded-md p-2"></div>
                            <div><label for="movie-seats" class="block text-sm font-medium">Places</label><input type="number" id="movie-seats" min="1" max="300" required class="mt-1 block w-full border rounded-md p-2"></div>
                            <button type="submit" id="add-movie-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md">‚ûï Ajouter le Film</button>
                        </form>
                    </div>
                    <div>
                        <h4 class="font-medium mb-3">Films Existants</h4>
                        <div id="admin-movies-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-semibold mb-4">üìã Toutes les R√©servations</h3>
                <div id="admin-reservations-list" class="space-y-3"></div>
            </div>
        </div>
    </main>

    <!-- Modals -->
    <div id="booking-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">R√©server des Places</h3>
            <div id="booking-movie-info" class="mb-4"></div>
            <form id="booking-form">
                <div class="space-y-3">
                    <div><label for="seats-count" class="block text-sm font-medium">Nombre de Places</label><input type="number" id="seats-count" min="1" max="10" value="1" required class="mt-1 block w-full border rounded-md p-2"></div>
                    <div id="total-price" class="text-lg font-semibold text-green-600"></div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeBookingModal()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md">Annuler</button>
                    <button type="submit" id="confirm-booking-btn" class="flex-1 bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md">Confirmer</button>
                </div>
            </form>
        </div>
    </div>
    <div id="comment-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">Ajouter un Commentaire</h3>
            <div id="comment-movie-info" class="mb-4"></div>
            <form id="comment-form">
                <div class="space-y-3">
                    <div>
                        <label for="comment-rating" class="block text-sm font-medium">Note (1-5 √©toiles)</label>
                        <select id="comment-rating" required class="mt-1 block w-full border rounded-md p-2">
                            <option value="">Choisir une note</option><option value="1">‚≠ê 1</option><option value="2">‚≠ê‚≠ê 2</option><option value="3">‚≠ê‚≠ê‚≠ê 3</option><option value="4">‚≠ê‚≠ê‚≠ê‚≠ê 4</option><option value="5">‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê 5</option>
                        </select>
                    </div>
                    <div><label for="comment-text" class="block text-sm font-medium">Commentaire</label><textarea id="comment-text" rows="4" required class="mt-1 block w-full border rounded-md p-2"></textarea></div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeCommentModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md">Annuler</button>
                    <button type="submit" id="submit-comment-btn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md">Publier</button>
                </div>
            </form>
        </div>
    </div>
    <div id="edit-movie-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
            <h3 class="text-xl font-semibold mb-4">Modifier le Film</h3>
            <form id="edit-movie-form">
                <div class="space-y-3">
                    <div><label for="edit-movie-title" class="block text-sm font-medium">Titre</label><input type="text" id="edit-movie-title" required class="mt-1 block w-full border rounded-md p-2"></div>
                    <div><label for="edit-movie-genre" class="block text-sm font-medium">Genre</label>
                        <select id="edit-movie-genre" required class="mt-1 block w-full border rounded-md p-2">
                            <option value="">S√©lectionner</option><option value="Action">Action</option><option value="Com√©die">Com√©die</option><option value="Drame">Drame</option><option value="Horreur">Horreur</option><option value="Romance">Romance</option><option value="Sci-Fi">Science-Fiction</option>
                        </select>
                    </div>
                    <div><label for="edit-movie-duration" class="block text-sm font-medium">Dur√©e</label><input type="text" id="edit-movie-duration" required class="mt-1 block w-full border rounded-md p-2"></div>
                    <div><label for="edit-movie-price" class="block text-sm font-medium">Prix (‚Ç¨)</label><input type="number" id="edit-movie-price" required class="mt-1 block w-full border rounded-md p-2"></div>
                    <div><label for="edit-movie-showtime" class="block text-sm font-medium">Horaire</label><input type="datetime-local" id="edit-movie-showtime" required class="mt-1 block w-full border rounded-md p-2"></div>
                    <div><label for="edit-movie-seats" class="block text-sm font-medium">Places</label><input type="number" id="edit-movie-seats" required class="mt-1 block w-full border rounded-md p-2"></div>
                </div>
                <div class="flex space-x-3 mt-6">
                    <button type="button" onclick="closeEditMovieModal()" class="flex-1 bg-gray-500 text-white py-2 px-4 rounded-md">Annuler</button>
                    <button type="submit" id="update-movie-btn" class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-md">Modifier</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Configuration de l'API
        const API_BASE_URL = 'http://localhost:8080/api';

        // Variables globales
        let currentUser = null;
        let selectedRole = 'user';
        let movies = [];
        let reservations = [];
        let comments = [];
        let users = [];
        let currentBookingMovie = null;
        let currentCommentMovie = null;
        let currentEditMovie = null;

        // Fonctions utilitaires
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast px-6 py-3 rounded-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            toast.textContent = message;
            document.getElementById('toast-container').appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleString('fr-FR', { dateStyle: 'medium', timeStyle: 'short' });
        }

        // Navigation
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            
            const targetPage = document.getElementById(pageName + '-page');
            if (targetPage) targetPage.classList.add('active');

            const navLink = document.getElementById('nav-' + pageName);
            if (navLink) navLink.classList.add('active');

            if (!currentUser && ['reservations', 'profile', 'admin'].includes(pageName)) {
                showPage('login');
                showToast('Veuillez vous connecter.', 'error');
                return;
            }
            if (pageName === 'admin' && currentUser?.userRole !== 'admin') {
                showPage('home');
                showToast('Acc√®s administrateur requis.', 'error');
            }
        }

        // Gestion des r√¥les
        function selectRole(role) {
            selectedRole = role;
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('border-blue-500', 'bg-blue-50'));
            document.getElementById('role-' + role).classList.add('border-blue-500', 'bg-blue-50');
        }

        // --- COMMUNICATION AVEC LE BACKEND ---
        async function apiRequest(endpoint, method = 'GET', body = null) {
            try {
                const options = {
                    method,
                    headers: { 'Content-Type': 'application/json' }
                };
                if (body) {
                    options.body = JSON.stringify(body);
                }
                const response = await fetch(API_BASE_URL + endpoint, options);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                return response.status === 204 ? null : response.json();
            } catch (error) {
                console.error(`Erreur API pour ${method} ${endpoint}:`, error);
                showToast('Une erreur de communication est survenue.', 'error');
                return null;
            }
        }

        async function fetchAllData() {
            const [moviesData, reservationsData, commentsData, usersData] = await Promise.all([
                apiRequest('/movies'),
                apiRequest('/reservations'),
                apiRequest('/comments'),
                apiRequest('/users')
            ]);
            movies = moviesData || [];
            reservations = reservationsData || [];
            comments = commentsData || [];
            users = usersData || [];
            updateAllPages();
        }

        // Authentification
        function showRegisterForm() {
            document.getElementById('register-form').classList.toggle('hidden');
        }

        async function login(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');
            
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            const response = await fetch(`${API_BASE_URL}/users/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });

            if (response.ok) {
                const user = await response.json();
                if (user.userRole === selectedRole) {
                    currentUser = user;
                    updateUserInterface();
                    await fetchAllData();
                    showPage('home');
                    showToast(`Bienvenue ${user.firstName} !`);
                } else {
                    showToast('Type de compte incorrect.', 'error');
                }
            } else {
                showToast('Nom d\'utilisateur ou mot de passe incorrect.', 'error');
            }
            btn.classList.remove('loading');
        }

        async function register(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');

            const userData = {
                username: document.getElementById('reg-username').value,
                email: document.getElementById('reg-email').value,
                password: document.getElementById('reg-password').value,
                firstName: document.getElementById('reg-firstname').value,
                lastName: document.getElementById('reg-lastname').value,
                phone: document.getElementById('reg-phone').value,
                userRole: selectedRole,
                createdAt: new Date().toISOString()
            };

            const existingUser = users.find(u => u.username === userData.username || u.email === userData.email);
            if(existingUser) {
                showToast('Nom d\'utilisateur ou email d√©j√† utilis√©.', 'error');
                btn.classList.remove('loading');
                return;
            }

            const newUser = await apiRequest('/users', 'POST', userData);
            if (newUser) {
                await fetchAllData();
                showToast('Compte cr√©√© avec succ√®s !');
                document.getElementById('registration-form').reset();
                document.getElementById('register-form').classList.add('hidden');
            }
            btn.classList.remove('loading');
        }

        function logout() {
            currentUser = null;
            updateUserInterface();
            showPage('login');
            showToast('D√©connexion r√©ussie.');
        }

        function updateUserInterface() {
            const userMenu = document.getElementById('user-menu');
            const guestMenu = document.getElementById('guest-menu');
            const navReservations = document.getElementById('nav-reservations');
            const navAdmin = document.getElementById('nav-admin');

            if (currentUser) {
                userMenu.classList.remove('hidden');
                guestMenu.classList.add('hidden');
                document.getElementById('user-welcome').textContent = `${currentUser.firstName} ${currentUser.lastName}`;
                navReservations.classList.remove('hidden');
                if (currentUser.userRole === 'admin') {
                    navAdmin.classList.remove('hidden');
                } else {
                    navAdmin.classList.add('hidden');
                }
            } else {
                userMenu.classList.add('hidden');
                guestMenu.classList.remove('hidden');
                navReservations.classList.add('hidden');
                navAdmin.classList.add('hidden');
            }
        }
        
        // --- GESTION DES FILMS (ADMIN) ---
        async function addMovie(event) {
            event.preventDefault();
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');
            
            const movieData = {
                title: document.getElementById('movie-title').value,
                genre: document.getElementById('movie-genre').value,
                duration: document.getElementById('movie-duration').value,
                price: parseFloat(document.getElementById('movie-price').value),
                showtime: document.getElementById('movie-showtime').value,
                availableSeats: parseInt(document.getElementById('movie-seats').value),
                createdAt: new Date().toISOString(),
                userId: currentUser.id,
                userRole: currentUser.userRole
            };

            const result = await apiRequest('/movies', 'POST', movieData);
            if (result) {
                await fetchAllData();
                showToast('Film ajout√© avec succ√®s !');
                document.getElementById('add-movie-form').reset();
            }
            btn.classList.remove('loading');
        }

        async function deleteMovie(movieId) {
            if (!confirm('√ätes-vous s√ªr de vouloir supprimer ce film ?')) return;
            const result = await apiRequest(`/movies/${movieId}`, 'DELETE');
            showToast('Film supprim√©.');
            await fetchAllData();
        }

        function openEditMovieModal(movieId) {
            currentEditMovie = movies.find(m => m.id === movieId);
            if (!currentEditMovie) return;
            document.getElementById('edit-movie-title').value = currentEditMovie.title;
            document.getElementById('edit-movie-genre').value = currentEditMovie.genre;
            document.getElementById('edit-movie-duration').value = currentEditMovie.duration;
            document.getElementById('edit-movie-price').value = currentEditMovie.price;
            document.getElementById('edit-movie-showtime').value = currentEditMovie.showtime;
            document.getElementById('edit-movie-seats').value = currentEditMovie.availableSeats;
            document.getElementById('edit-movie-modal').classList.remove('hidden');
        }

        function closeEditMovieModal() {
            document.getElementById('edit-movie-modal').classList.add('hidden');
            currentEditMovie = null;
        }

        async function updateMovie(event) {
            event.preventDefault();
            if (!currentEditMovie) return;
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');
            
            const updatedData = {
                ...currentEditMovie,
                title: document.getElementById('edit-movie-title').value,
                genre: document.getElementById('edit-movie-genre').value,
                duration: document.getElementById('edit-movie-duration').value,
                price: parseFloat(document.getElementById('edit-movie-price').value),
                showtime: document.getElementById('edit-movie-showtime').value,
                availableSeats: parseInt(document.getElementById('edit-movie-seats').value)
            };

            const result = await apiRequest(`/movies/${currentEditMovie.id}`, 'PUT', updatedData);
            if (result) {
                await fetchAllData();
                showToast('Film modifi√© avec succ√®s !');
                closeEditMovieModal();
            }
            btn.classList.remove('loading');
        }

        // --- GESTION DES R√âSERVATIONS ---
        function openBookingModal(movieId) {
            if (!currentUser) {
                showToast('Veuillez vous connecter pour r√©server.', 'error');
                showPage('login');
                return;
            }
            currentBookingMovie = movies.find(m => m.id === movieId);
            if (!currentBookingMovie || currentBookingMovie.availableSeats <= 0) {
                showToast('Aucune place disponible.', 'error');
                return;
            }
            document.getElementById('booking-movie-info').innerHTML = `
                <div class="bg-gray-50 p-3 rounded">
                    <h4 class="font-semibold">${currentBookingMovie.title}</h4>
                    <p class="text-sm text-gray-600">${currentBookingMovie.genre} ‚Ä¢ S√©ance: ${formatDateTime(currentBookingMovie.showtime)}</p>
                    <p class="text-sm text-gray-600">Places restantes: ${currentBookingMovie.availableSeats}</p>
                </div>`;
            updateBookingPrice();
            document.getElementById('booking-modal').classList.remove('hidden');
        }

        function closeBookingModal() {
            document.getElementById('booking-modal').classList.add('hidden');
            currentBookingMovie = null;
        }

        function updateBookingPrice() {
            if (!currentBookingMovie) return;
            const seatsCount = parseInt(document.getElementById('seats-count').value) || 1;
            const maxSeats = Math.min(10, currentBookingMovie.availableSeats);
            document.getElementById('seats-count').max = maxSeats;
            if (seatsCount > maxSeats) document.getElementById('seats-count').value = maxSeats;
            const total = (seatsCount * currentBookingMovie.price).toFixed(2);
            document.getElementById('total-price').textContent = `Total: ${total}‚Ç¨`;
        }

        async function confirmBooking(event) {
            event.preventDefault();
            if (!currentBookingMovie || !currentUser) return;
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');
            
            const seatsCount = parseInt(document.getElementById('seats-count').value);
            if (seatsCount > currentBookingMovie.availableSeats) {
                showToast('Pas assez de places disponibles.', 'error');
                btn.classList.remove('loading');
                return;
            }

            const reservationData = {
                movieId: currentBookingMovie.id,
                title: currentBookingMovie.title,
                genre: currentBookingMovie.genre,
                showtime: currentBookingMovie.showtime,
                price: currentBookingMovie.price,
                customerName: `${currentUser.firstName} ${currentUser.lastName}`,
                customerEmail: currentUser.email,
                seatsBooked: seatsCount,
                createdAt: new Date().toISOString(),
                userId: currentUser.id,
                userRole: currentUser.userRole
            };

            const reservationResult = await apiRequest('/reservations', 'POST', reservationData);
            if (reservationResult) {
                const updatedMovie = { ...currentBookingMovie, availableSeats: currentBookingMovie.availableSeats - seatsCount };
                await apiRequest(`/movies/${currentBookingMovie.id}`, 'PUT', updatedMovie);
                await fetchAllData();
                showToast('R√©servation confirm√©e !');
                closeBookingModal();
            }
            btn.classList.remove('loading');
        }

        async function cancelReservation(reservationId) {
            if (!confirm('√ätes-vous s√ªr de vouloir annuler cette r√©servation ?')) return;

            const reservation = reservations.find(r => r.id === reservationId);
            if (!reservation) return;

            const movie = movies.find(m => m.id === reservation.movieId);
            if (movie) {
                const updatedMovie = { ...movie, availableSeats: movie.availableSeats + reservation.seatsBooked };
                await apiRequest(`/movies/${movie.id}`, 'PUT', updatedMovie);
            }

            await apiRequest(`/reservations/${reservationId}`, 'DELETE');
            showToast('R√©servation annul√©e.');
            await fetchAllData();
        }

        // --- GESTION DES COMMENTAIRES ---
        function openCommentModal(movieId) {
            if (!currentUser) {
                showToast('Veuillez vous connecter pour commenter.', 'error');
                showPage('login');
                return;
            }
            currentCommentMovie = movies.find(m => m.id === movieId);
            if (!currentCommentMovie) return;
            document.getElementById('comment-movie-info').innerHTML = `<h4 class="font-semibold">${currentCommentMovie.title}</h4>`;
            document.getElementById('comment-modal').classList.remove('hidden');
        }

        function closeCommentModal() {
            document.getElementById('comment-modal').classList.add('hidden');
            currentCommentMovie = null;
        }

        async function submitComment(event) {
            event.preventDefault();
            if (!currentCommentMovie || !currentUser) return;
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');

            const commentData = {
                movieId: currentCommentMovie.id,
                comment: document.getElementById('comment-text').value,
                rating: parseInt(document.getElementById('comment-rating').value),
                authorName: `${currentUser.firstName} ${currentUser.lastName}`,
                createdAt: new Date().toISOString(),
                userId: currentUser.id,
                userRole: currentUser.userRole
            };

            const result = await apiRequest('/comments', 'POST', commentData);
            if (result) {
                await fetchAllData();
                showToast('Commentaire publi√© !');
                closeCommentModal();
            }
            btn.classList.remove('loading');
        }

        // --- GESTION DU PROFIL ---
        async function updateProfile(event) {
            event.preventDefault();
            if (!currentUser) return;
            const btn = event.target.querySelector('button');
            btn.classList.add('loading');
            
            const updatedUser = {
                ...currentUser,
                firstName: document.getElementById('profile-firstname').value,
                lastName: document.getElementById('profile-lastname').value,
                username: document.getElementById('profile-username').value,
                email: document.getElementById('profile-email').value,
                phone: document.getElementById('profile-phone').value
            };

            const result = await apiRequest(`/users/${currentUser.id}`, 'PUT', updatedUser);
            if (result) {
                currentUser = result; // Mettre √† jour avec la r√©ponse du serveur
                await fetchAllData();
                updateUserInterface();
                showToast('Profil mis √† jour !');
            }
            btn.classList.remove('loading');
        }
        
        // --- MISE √Ä JOUR DE L'INTERFACE ---
        function getMovieCardHTML(movie) {
            const movieComments = comments.filter(c => c.movieId === movie.id);
            const avgRating = movieComments.length > 0 ? (movieComments.reduce((sum, c) => sum + c.rating, 0) / movieComments.length).toFixed(1) : null;
            return `
                <div class="bg-white rounded-lg shadow-md p-6 hover:shadow-lg transition-shadow cursor-pointer" onclick="showMovieDetail(${movie.id})">
                    <h4 class="text-lg font-semibold mb-2">${movie.title}</h4>
                    <div class="space-y-1 text-sm text-gray-600 mb-4">
                        <p>üé≠ ${movie.genre}</p>
                        <p>‚è±Ô∏è ${movie.duration}</p>
                        <p>üí∞ ${movie.price}‚Ç¨</p>
                        <p>üìÖ ${formatDateTime(movie.showtime)}</p>
                        <p class="${movie.availableSeats > 0 ? 'text-green-600' : 'text-red-600'}">ü™ë ${movie.availableSeats} places</p>
                        ${avgRating ? `<p>‚≠ê ${avgRating}/5 (${movieComments.length} avis)</p>` : '<p class="text-gray-400">Aucun avis</p>'}
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="event.stopPropagation(); openBookingModal(${movie.id})" 
                                ${movie.availableSeats <= 0 ? 'disabled' : ''}
                                class="flex-1 ${movie.availableSeats > 0 ? 'bg-green-600' : 'bg-gray-400'} text-white py-2 px-4 rounded-md">
                            ${movie.availableSeats > 0 ? 'üé´ R√©server' : 'Complet'}
                        </button>
                        <button onclick="event.stopPropagation(); showMovieDetail(${movie.id})" class="bg-blue-600 text-white py-2 px-4 rounded-md">
                            üëÅÔ∏è Voir
                        </button>
                    </div>
                </div>`;
        }
        
        function updateAllPages() {
            updateHomePage();
            updateMoviesPage();
            updateReservationsPage();
            updateAdminPage();
            updateProfilePage();
            // Mettre √† jour la page de d√©tail si elle est active
            const detailPage = document.getElementById('movie-detail-page');
            if(detailPage.classList.contains('active')){
                const movieId = document.querySelector('#movie-detail-content h1')?.dataset.movieId;
                if(movieId) showMovieDetail(parseInt(movieId));
            }
        }

        function updateHomePage() {
            const recentMovies = [...movies].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 3);
            const recentContainer = document.getElementById('recent-movies');
            recentContainer.innerHTML = recentMovies.length > 0 ? recentMovies.map(getMovieCardHTML).join('') : '<p>Aucun film r√©cent.</p>';
            document.getElementById('total-movies').textContent = movies.length;
            document.getElementById('total-seats').textContent = movies.reduce((sum, movie) => sum + movie.availableSeats, 0);
            document.getElementById('total-reservations').textContent = reservations.length;
        }

        function updateMoviesPage() {
            const container = document.getElementById('all-movies-grid');
            container.innerHTML = movies.length > 0 ? movies.map(getMovieCardHTML).join('') : '<p>Aucun film disponible.</p>';
        }

        function updateReservationsPage() {
            if (!currentUser) return;
            const userReservations = reservations.filter(r => r.userId === currentUser.id);
            const container = document.getElementById('user-reservations-list');
            container.innerHTML = userReservations.length > 0 ? userReservations.map(res => `
                <div class="bg-white rounded-lg shadow-md p-4 flex justify-between items-start">
                    <div>
                        <h5 class="font-semibold">${res.title}</h5>
                        <p class="text-sm text-gray-600">Places: ${res.seatsBooked} ‚Ä¢ Total: ${(res.seatsBooked * res.price).toFixed(2)}‚Ç¨</p>
                        <p class="text-sm text-gray-600">R√©serv√© le: ${formatDateTime(res.createdAt)}</p>
                    </div>
                    <button onclick="cancelReservation(${res.id})" class="bg-red-500 text-white px-3 py-1 rounded text-sm">‚ùå Annuler</button>
                </div>`).join('') : '<p>Aucune r√©servation.</p>';
        }

        function showMovieDetail(movieId) {
            const movie = movies.find(m => m.id === movieId);
            if (!movie) return;
            const movieComments = comments.filter(c => c.movieId === movieId);
            const avgRating = movieComments.length > 0 ? (movieComments.reduce((sum, c) => sum + c.rating, 0) / movieComments.length).toFixed(1) : 'Aucune note';
            
            document.getElementById('movie-detail-content').innerHTML = `
                <div class="bg-white rounded-lg shadow-lg p-8">
                    <div class="grid md:grid-cols-2 gap-8">
                        <div>
                            <h1 class="text-3xl font-bold mb-4" data-movie-id="${movie.id}">${movie.title}</h1>
                            <p><strong>Genre:</strong> ${movie.genre}</p>
                            <p><strong>Prix:</strong> ${movie.price}‚Ç¨</p>
                            <p><strong>S√©ance:</strong> ${formatDateTime(movie.showtime)}</p>
                            <p><strong>Places:</strong> ${movie.availableSeats}</p>
                            <p><strong>Note:</strong> ${avgRating} ‚≠ê</p>
                            <div class="flex space-x-3 mt-4">
                                <button onclick="openBookingModal(${movie.id})" class="bg-green-600 text-white py-2 px-4 rounded">R√©server</button>
                                <button onclick="openCommentModal(${movie.id})" class="bg-blue-600 text-white py-2 px-4 rounded">Commenter</button>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-semibold mb-4">Commentaires</h3>
                            <div class="space-y-4 max-h-96 overflow-y-auto">
                                ${movieComments.length === 0 ? '<p>Aucun commentaire.</p>' : movieComments.map(c => `
                                    <div class="bg-gray-50 p-3 rounded">
                                        <p><strong>${c.authorName}</strong> (${'‚≠ê'.repeat(c.rating)})</p>
                                        <p>${c.comment}</p>
                                        <p class="text-sm text-gray-500">${formatDateTime(c.createdAt)}</p>
                                    </div>`).join('')
                                }
                            </div>
                        </div>
                    </div>
                </div>`;
            showPage('movie-detail');
        }

        function updateAdminPage() {
            if (!currentUser || currentUser.userRole !== 'admin') return;

            const moviesContainer = document.getElementById('admin-movies-list');
            moviesContainer.innerHTML = movies.map(movie => `
                <div class="border rounded-lg p-3 flex justify-between items-center">
                    <div>
                        <h5 class="font-semibold">${movie.title}</h5>
                        <p class="text-sm text-gray-600">${movie.availableSeats} places</p>
                    </div>
                    <div>
                        <button onclick="openEditMovieModal(${movie.id})" class="bg-blue-500 text-white px-2 py-1 rounded text-sm">Modifier</button>
                        <button onclick="deleteMovie(${movie.id})" class="bg-red-500 text-white px-2 py-1 rounded text-sm ml-2">Supprimer</button>
                    </div>
                </div>`).join('');

            const reservationsContainer = document.getElementById('admin-reservations-list');
            reservationsContainer.innerHTML = reservations.map(res => `
                <div class="border rounded-lg p-3">
                    <h5 class="font-semibold">${res.title}</h5>
                    <p class="text-sm">Client: ${res.customerName}</p>
                    <p class="text-sm">${res.seatsBooked} places</p>
                </div>`).join('');
        }

        function updateProfilePage() {
            if (!currentUser) return;
            document.getElementById('profile-firstname').value = currentUser.firstName || '';
            document.getElementById('profile-lastname').value = currentUser.lastName || '';
            document.getElementById('profile-username').value = currentUser.username || '';
            document.getElementById('profile-email').value = currentUser.email || '';
            document.getElementById('profile-phone').value = currentUser.phone || '';
            document.getElementById('profile-role').value = currentUser.userRole;
            
            const userReservations = reservations.filter(r => r.userId === currentUser.id);
            document.getElementById('user-total-reservations').textContent = userReservations.length;
            document.getElementById('user-total-tickets').textContent = userReservations.reduce((sum, r) => sum + r.seatsBooked, 0);
        }

        // Event Listeners
        document.getElementById('login-form').addEventListener('submit', login);
        document.getElementById('registration-form').addEventListener('submit', register);
        document.getElementById('add-movie-form').addEventListener('submit', addMovie);
        document.getElementById('booking-form').addEventListener('submit', confirmBooking);
        document.getElementById('profile-form').addEventListener('submit', updateProfile);
        document.getElementById('comment-form').addEventListener('submit', submitComment);
        document.getElementById('edit-movie-form').addEventListener('submit', updateMovie);
        document.getElementById('seats-count').addEventListener('input', updateBookingPrice);
        
        // Initialisation
        async function init() {
            selectRole('user');
            showPage('home');
            await fetchAllData();
            console.log('Application initialis√©e.');
        }

        // Lancer l'application
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
